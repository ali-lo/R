--Fact_ProductSalesTarget
CREATE OR REPLACE TABLE FACT_PRODUCTSALESTARGET(
    DimProductID INTEGER CONSTRAINT FK_DimProductID FOREIGN KEY REFERENCES DIM_PRODUCT(DimProductID) --Foreign Key
    ,DimTargetDateID NUMBER(9,0) CONSTRAINT FK_DimTargetDateID FOREIGN KEY REFERENCES DIM_DATE(Date_PKey) --Foreign Key
    ,ProductTargetSalesQuantity FLOAT(10) NOT NULL
);

SELECT * FROM FACT_PRODUCTSALESTARGET;

INSERT INTO FACT_PRODUCTSALESTARGET(
    DimProductID
    ,DimTargetDateID
    ,ProductTargetSalesQuantity
)
SELECT DISTINCT
    DIM_PRODUCT.DimProductID
    ,DIM_DATE.Date_PKey
    ,ROUND(STAGE_TARGETPRODUCT.SalesQuantityTarget/365, 2) AS ProductTargeSalesQuantity
FROM STAGE_TARGETPRODUCT
    INNER JOIN DIM_DATE
    ON DIM_DATE.Year = STAGE_TARGETPRODUCT.Year
    INNER JOIN DIM_PRODUCT
    ON DIM_PRODUCT.DimProductID = STAGE_TARGETPRODUCT.ProductID;

SELECT * FROM FACT_PRODUCTSALESTARGET;

--Fact_SRCSalesTarget
CREATE OR REPLACE TABLE Fact_SRCSalesTarget(
    DimStoreID INTEGER CONSTRAINT FK_DimStoreID FOREIGN KEY REFERENCES DIM_STORE(DimStoreID) --Foreign Key
    ,DimResellerID INTEGER CONSTRAINT FK_DimResellerID FOREIGN KEY REFERENCES DIM_RESELLER(DimResellerID) --Foreign Key
    ,DimChannelID INTEGER CONSTRAINT FK_DimChannelID FOREIGN KEY REFERENCES DIM_CHANNEL(DimChannelID) --Foreign Key 
    ,DimTargetDateID NUMBER(9,0) CONSTRAINT FK_DimTargetDateID FOREIGN KEY REFERENCES DIM_DATE(Date_Pkey)
    ,SalesTargetAmount FLOAT(10) NOT NULL
);

SELECT * FROM FACT_SRCSALESTARGET;

INSERT INTO FACT_SRCSALESTARGET(
    DimStoreID
    ,DimResellerID
    ,DimChannelID
    ,DimTargetDateID
    ,SalesTargetAmount
)
SELECT DISTINCT
    NVL(DIM_STORE.DimStoreID, -1) AS DimStoreID
    ,NVL(DIM_RESELLER.DimResellerID, -1) AS DimResellerID
    ,NVL(DIM_CHANNEL.DimChannelID, -1) AS DimChannelID
    ,DIM_DATE.Date_Pkey
    ,ROUND(STAGE_TARGETCHANNELSTORE.TargetSalesAmount/ 365, 2) AS SalesTargetAmount
FROM STAGE_TARGETCHANNELSTORE
    LEFT JOIN DIM_STORE
    ON DIM_STORE.StoreNumber = 
    CASE
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 5' THEN 5
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 8' THEN 8
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 10' THEN 10
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 21' THEN 21
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 34' THEN 34
        WHEN STAGE_TARGETCHANNELSTORE.TargetName = 'Store Number 39' THEN 39
        ELSE -1
        END  
    LEFT JOIN DIM_RESELLER
    ON DIM_RESELLER.ResellerName = STAGE_TARGETCHANNELSTORE.TargetName
    LEFT JOIN DIM_CHANNEL
    ON DIM_CHANNEL.ChannelName = 
    CASE
        WHEN STAGE_TARGETCHANNELSTORE.ChannelName = 'Online' THEN 'On-line'
        ELSE STAGE_TARGETCHANNELSTORE.ChannelName
        END
    LEFT JOIN DIM_DATE
    ON DIM_DATE.Year = STAGE_TARGETCHANNELSTORE.Year;

SELECT * FROM FACT_SRCSALESTARGET;

--Fact_SalesActual
CREATE OR REPLACE TABLE Fact_SalesActual(
    DimProductID INTEGER CONSTRAINT FK_DimProductID FOREIGN KEY REFERENCES DIM_PRODUCT(DimProductID) --Foreign Key 
    ,DimStoreID INTEGER CONSTRAINT FK_DimStoreID FOREIGN KEY REFERENCES DIM_STORE(DimStoreID) --Foreign Key
    ,DimResellerID INTEGER CONSTRAINT FK_DimResellerID FOREIGN KEY REFERENCES DIM_RESELLER(DimResellerID) --Foreign Key
    ,DimCustomerID INTEGER CONSTRAINT FK_DimCustomertID FOREIGN KEY REFERENCES DIM_CUSTOMER(DimCustomerID) --Foreign Key
    ,DimChannelID INTEGER CONSTRAINT FK_DimChannelID FOREIGN KEY REFERENCES DIM_CHANNEL(DimChannelID) --Foreign Key
    ,DimSaleDateID NUMBER(9,0) CONSTRAINT FK_DimSaleDateID FOREIGN KEY REFERENCES DIM_DATE(Date_PKey) --Foreign Key
    ,DimLocationID INTEGER CONSTRAINT FK_DimLocationID FOREIGN KEY REFERENCES DIM_LOCATION(DimLocationID) --Foreign Key
    ,SalesHeaderID NUMBER(38,0) NOT NULL
    ,SalesDetailID NUMBER(38,0) NOT NULL
    ,SaleAmount FLOAT(10) NOT NULL
    ,SaleQuantity NUMBER(38,0) NOT NULL
    ,SaleUnitPrice FLOAT(10)
    ,SaleExtendedCost FLOAT(10)
    ,SaleTotalProfit FLOAT(10)
);

SELECT * FROM FACT_SALESACTUAL;

INSERT INTO FACT_SALESACTUAL(
   DimProductID
   ,DimStoreID
   ,DimResellerID
   ,DimCustomerID
   ,DimChannelID
   ,DimSaleDateID
   ,DimLocationID
   ,SalesHeaderID
   ,SalesDetailID
   ,SaleAmount
   ,SaleQuantity
   ,SaleUnitPrice
   ,SaleExtendedCost
   ,SaleTotalProfit
)
SELECT DISTINCT
    DIM_PRODUCT.DimProductID AS DimProductID
    ,NVL(DIM_STORE.DimStoreID, -1) AS DimStoreID
    ,NVL(DIM_RESELLER.DimResellerID, -1) AS DimResellerID
    ,NVL(DIM_CUSTOMER.DimCustomerID, -1) AS DimCustomerID
    ,NVL(DIM_CHANNEL.DimChannelID, -1) AS DimChannelID
    ,DIM_DATE.Date_PKey AS DimSaleDateID
    ,NVL(DL.DimLocationID,-1) AS DimLocationID
    ,STAGE_SALESDETAILS.SalesHeaderID AS SaleHeaderID
    ,STAGE_SALESDETAILS.SalesDetailID AS SaleDetailID
    ,STAGE_SALESDETAILS.SalesAmount AS SaleAmount
    ,STAGE_SALESDETAILS.SalesQuantity AS SaleQuantity
    ,ROUND((STAGE_SALESDETAILS.SALESAMOUNT / STAGE_SALESDETAILS.SALESQUANTITY), 2) AS SALEUNITPRICE
    ,ROUND((STAGE_SALESDETAILS.SALESQUANTITY * DIM_PRODUCT.PRODUCTCOST), 2) AS SALEEXTENDEDCOST
    ,ROUND((STAGE_SALESDETAILS.SALESAMOUNT-SALEEXTENDEDCOST), 2) AS SALETOTALPROFIT
FROM STAGE_SALESHEADER
    INNER JOIN STAGE_SALESDETAILS
    ON STAGE_SALESHEADER.SalesHeaderID = STAGE_SALESDETAILS.SalesHeaderID
    INNER JOIN DIM_DATE
    ON DIM_DATE.Date = STAGE_SALESHEADER.Date
    /*CASE
        WHERE TRY_CAST(STAGE_SALESHEADER.Date AS DATE)
        ELSE -1
        END */
    INNER JOIN DIM_CHANNEL
    ON STAGE_SALESHEADER.ChannelID = DIM_CHANNEL.ChannelID
    LEFT JOIN DIM_CUSTOMER
    ON STAGE_SALESHEADER.CustomerID = DIM_CUSTOMER.CustomerID
    LEFT JOIN DIM_RESELLER
    ON STAGE_SALESHEADER.ResellerID = DIM_RESELLER.ResellerID
    LEFT JOIN DIM_STORE
    ON STAGE_SALESHEADER.StoreID = DIM_STORE.SourceStoreID
    INNER JOIN DIM_PRODUCT
    ON STAGE_SALESDETAILS.ProductID = DIM_PRODUCT.ProductID
    LEFT OUTER JOIN DIM_LOCATION AS DL 
    ON CASE
        WHEN Stage_SalesHeader.StoreID IS NOT NULL THEN Dim_Store.DimLocationID = DL.DimLocationID
        WHEN Stage_SalesHeader.ResellerID IS NOT NULL THEN Dim_Reseller.DimLocationID = DL.DimLocationID
        WHEN Stage_SalesHeader.CustomerID IS NOT NULL THEN Dim_Customer.DimLocationID = DL.DimLocationID
        END
    ;

SELECT * FROM FACT_SALESACTUAL;
